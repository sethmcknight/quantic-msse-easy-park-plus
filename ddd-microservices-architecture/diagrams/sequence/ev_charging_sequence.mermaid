sequenceDiagram
    participant EV as EV Driver
    participant C as Charger
    participant EC as EV Charging Service
    participant PO as Parking Operations
    participant BS as Billing Service
    participant AS as Administration Service
    
    EV->>C: Plugs in vehicle
    C->>EC: Charging session requested
    EC->>PO: Get active visit for vehicle
    PO-->>EC: Visit details
    
    EC->>AS: Check charger availability and policies
    AS-->>EC: Charger status and lot EV policies
    
    EC->>EC: Create charging session
    EC->>C: Authorize charging
    C->>C: Start power delivery
    C-->>EV: Charging initiated
    
    Note over EC: Session status: ChargingInProgress
    
    loop During charging
        C->>EC: Report energy consumption
        EC->>EC: Update session energy data
    end
    
    alt Charging completes naturally
        C->>EC: Charging complete
        EC->>EC: Start grace period timer
        Note over EC: Session status: ChargingComplete_GracePeriodActive
        
        alt Grace period expires
            EC->>EC: Start idle time tracking
            Note over EC: Session status: ChargingComplete_IdleDetected
        end
    end
    
    EV->>C: Unplugs vehicle
    C->>EC: Session ended
    EC->>EC: Finalize charging session
    EC->>BS: Generate charging bill
    BS->>BS: Calculate charging fees and idle fees
    BS-->>EC: Bill created
    
    Note over EC: Session status: Unplugged_SessionEnded